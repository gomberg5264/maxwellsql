#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

### Configure environment

set -o errexit    # always exit on error
set -o pipefail   # don't ignore exit codes when piping output
set -o nounset    # fail on unset variables
unset GIT_DIR     # Avoid GIT_DIR leak from previous build steps

### Configure directories

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)

### Create 

mkdir -p "$BUILD_DIR/.heroku/"
cd "$BUILD_DIR"

LOG_FILE='/tmp/mysqld-build-log.txt'
echo "" > "$LOG_FILE"



# ------------------------------------------------------------
if [ ! -e "$CACHE_DIR/mysql-8.0.12-linux-glibc2.12-x86_64.tar.xz" ]; then
  echo '       * Downloading source code'
  curl -# -L -o "$CACHE_DIR/mysql-8.0.12-linux-glibc2.12-x86_64.tar.xz" 'https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.12-linux-glibc2.12-x86_64.tar.xz'
fi

if [ ! -e "$CACHE_DIR/libaio.so.1" ]; then
  echo '       * Downloading libraries'
  cp "$BP_DIR"/lib/lib*.so* "$CACHE_DIR"
fi
# ------------------------------------------------------------



# ------------------------------------------------------------
echo '       * Installing'
mkdir -p "$BUILD_DIR/.heroku/"
cd "$BUILD_DIR/.heroku/"
tar xJf "$CACHE_DIR/mysql-8.0.12-linux-glibc2.12-x86_64.tar.xz"
cd mysql-8.0.12-linux-glibc2.12-x86_64
cp "$CACHE_DIR"/lib*.so* lib
# ------------------------------------------------------------



# ------------------------------------------------------------
echo '       * Setup'

mkdir -p mysql-files
chmod 750 mysql-files

mkdir -p data
chmod 750 data

LD_LIBRARY_PATH=lib:${LD_LIBRARY_PATH:-} bin/mysqld --initialize-insecure  --datadir=data
LD_LIBRARY_PATH=lib:${LD_LIBRARY_PATH:-} bin/mysql_ssl_rsa_setup --datadir=data
# ------------------------------------------------------------